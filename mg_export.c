/*
 *  mg_export.c
 *
 *  November 2021 ops
 */

#include "tgi_utils.h"

#include <stdio.h>
#include <stdint.h>
#include <cbm.h>

static unsigned char MG_FILE_HEADER[] = {
  0xF1, 0x10, 0x0C, 0x12, 0xD8, 0x07, 0x9E, 0x20, 0x38, 0x35,
  0x38, 0x34, 0x00, 0x00, 0x00
};

static unsigned char MG_FILE_FOOTER[] = {
  0x18, 0xA9, 0x10, 0xA8, 0x99, 0xF0, 0x0F, 0x69, 0x0C, 0x90,
  0x02, 0xE9, 0xEF, 0xC8, 0xD0, 0xF4, 0xA0, 0x05, 0x18, 0xB9,
  0xE4, 0xED, 0x79, 0xFA, 0x21, 0x99, 0x00, 0x90, 0x88, 0x10,
  0xF3, 0xAD, 0x0E, 0x90, 0x29, 0x0F, 0x0D, 0x0E, 0x12, 0x8D,
  0x0E, 0x90, 0xAD, 0x0F, 0x12, 0x8D, 0x0F, 0x90, 0xA9, 0x10,
  0x85, 0xFB, 0xA9, 0x12, 0x85, 0xFC, 0xA9, 0x00, 0x85, 0xFD,
  0xA9, 0x11, 0x85, 0xFE, 0xA2, 0x0F, 0xA0, 0x00, 0xB1, 0xFB,
  0x91, 0xFD, 0xC8, 0xD0, 0xF9, 0xE6, 0xFC, 0xE6, 0xFE, 0xCA,
  0xD0, 0xF2, 0xA2, 0x00, 0xA0, 0x00, 0xBD, 0x10, 0x21, 0xE8,
  0x99, 0x00, 0x94, 0xC8, 0x4A, 0x4A, 0x4A, 0x4A, 0x99, 0x00,
  0x94, 0xC8, 0xC0, 0xF0, 0xD0, 0xEC, 0x20, 0xE4, 0xFF, 0xF0,
  0xFB, 0x4C, 0x32, 0xFD, 0x02, 0xFE, 0xFE, 0xEB, 0x00, 0x0C
};

int mg_export(const char *name,
              uint8_t foreground,
              uint8_t background,
              uint8_t border)
{
  uint8_t value;
  int i;
  FILE *f;

  /* Mask unused bits */
  foreground &= 0x07;
  background &= 0x0F;
  border &= 0x07;

  /* Set PRG filetype */
  _filetype = 'p';

  f = fopen(name, "w");
  if(f == 0)
    return -1;

  /* Write BASIC stub */
  fwrite(MG_FILE_HEADER, 1, sizeof(MG_FILE_HEADER), f);

  /* AUX color not used in B/W picture */
  value = 0x00;
  fwrite(&value, 1, 1, f);

  /* Background and border colors */
  value = (background << 4) | (1 << 3) | border;
  fwrite(&value, 1, 1, f);

  /* Write TGI image bitmap data */
  fwrite((void *)0x1100, 1, 3840, f);

  /* Write packed color memory */
  value = (foreground << 4) | foreground;
  for(i=0; i<120; ++i) {
    fwrite(&value, 1, 1, f);
  }

  /* Write code to display the image */
  fwrite(MG_FILE_FOOTER, 1, sizeof(MG_FILE_FOOTER), f);

  fclose(f);

  return 0;
}
